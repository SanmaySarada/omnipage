---
phase: 07-how-it-works
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - components/how-it-works/payment-flow-animation.tsx
  - components/how-it-works/how-it-works-section.tsx
autonomous: true

must_haves:
  truths:
    - "User sees card swipe animation as they start scrolling"
    - "User sees path drawing with particles during middle scroll"
    - "User sees funds split to ACH (school) and rewards (user) at end"
  artifacts:
    - path: "components/how-it-works/payment-flow-animation.tsx"
      provides: "Multi-phase scroll-linked payment flow visualization"
      exports: ["PaymentFlowAnimation"]
  key_links:
    - from: "components/how-it-works/payment-flow-animation.tsx"
      to: "useTransform"
      via: "scroll progress mapping"
      pattern: "useTransform.*progress"
    - from: "components/how-it-works/how-it-works-section.tsx"
      to: "PaymentFlowAnimation"
      via: "passes scrollYProgress prop"
      pattern: "PaymentFlowAnimation.*progress"
---

<objective>
Create the animated payment flow visualization with scroll-linked phases.

Purpose: Show users exactly how Omni works: card swipe initiates payment, funds flow through the network, then split automatically to school (ACH) and user (rewards).

Output: Scroll-linked animation with three distinct phases that progress as user scrolls through the section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-how-it-works/07-RESEARCH.md

@components/how-it-works/how-it-works-section.tsx (from Plan 01 - has scrollYProgress)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PaymentFlowAnimation component</name>
  <files>components/how-it-works/payment-flow-animation.tsx</files>
  <action>
Create the multi-phase scroll-linked animation component.

Structure:
- 'use client' directive
- Imports: motion, useTransform, MotionValue from 'motion/react'
- Import icons: CreditCard, Building2, Gift from 'lucide-react'

Props interface:
```typescript
interface PaymentFlowAnimationProps {
  progress: MotionValue<number>
}
```

Animation phases using useTransform:
1. Phase 1: Card Swipe (0% - 33% scroll)
   - cardX: [0, 0.33] -> ['-100%', '0%'] (card slides in from left)
   - cardOpacity: [0, 0.1] -> [0, 1]
   - cardScale: [0.2, 0.33] -> [0.9, 1]

2. Phase 2: Path Drawing (25% - 70% scroll, overlaps slightly for smoothness)
   - pathLength: [0.25, 0.7] -> [0, 1]
   - Create 3-5 particle divs that follow path using staggered progress

3. Phase 3: Split Animation (60% - 100% scroll)
   - achY: [0.6, 0.9] -> ['0%', '-40%'] (moves up)
   - achOpacity: [0.6, 0.75] -> [0, 1]
   - rewardsY: [0.6, 0.9] -> ['0%', '40%'] (moves down)
   - rewardsOpacity: [0.6, 0.75] -> [0, 1]

Step labels (show as user progresses):
- step1Opacity: [0, 0.15] -> [0, 1], [0.4, 0.5] -> [1, 0]
- step2Opacity: [0.3, 0.45] -> [0, 1], [0.7, 0.8] -> [1, 0]
- step3Opacity: [0.65, 0.8] -> [0, 1]

JSX structure:
```jsx
<div className="relative w-full h-full max-w-4xl mx-auto px-4">
  {/* Background heading */}
  <div className="absolute top-8 left-0 right-0 text-center">
    <h2 className="text-3xl md:text-4xl font-bold">How It Works</h2>
  </div>

  {/* Animation area */}
  <div className="relative h-full flex items-center justify-center">
    {/* Step 1: Card */}
    <motion.div style={{ x: cardX, opacity: cardOpacity, scale: cardScale }} className="absolute left-[10%]">
      <div className="w-32 h-20 md:w-48 md:h-28 rounded-xl bg-gradient-to-br from-primary to-primary/60 flex items-center justify-center shadow-xl">
        <CreditCard className="w-8 h-8 md:w-12 md:h-12 text-white" />
      </div>
      <motion.p style={{ opacity: step1Opacity }} className="text-center mt-4 font-medium">
        Swipe your card
      </motion.p>
    </motion.div>

    {/* Step 2: Flow path SVG */}
    <svg viewBox="0 0 400 200" className="absolute w-full max-w-lg" preserveAspectRatio="xMidYMid meet">
      {/* Background path (faint) */}
      <path
        d="M 50 100 C 120 100, 180 100, 200 100 L 200 100 C 220 100, 280 50, 350 30 M 200 100 C 220 100, 280 150, 350 170"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        className="text-muted-foreground/20"
      />
      {/* Animated path */}
      <motion.path
        d="M 50 100 C 120 100, 180 100, 200 100 L 200 100 C 220 100, 280 50, 350 30 M 200 100 C 220 100, 280 150, 350 170"
        fill="none"
        stroke="currentColor"
        strokeWidth="3"
        className="text-primary"
        style={{ pathLength }}
        strokeLinecap="round"
      />
    </svg>

    {/* Step 2 label */}
    <motion.p style={{ opacity: step2Opacity }} className="absolute text-center font-medium">
      Payment processes
    </motion.p>

    {/* Step 3: ACH destination (top) */}
    <motion.div style={{ y: achY, opacity: achOpacity }} className="absolute right-[10%] top-[20%]">
      <div className="w-20 h-20 md:w-24 md:h-24 rounded-xl bg-surface border-2 border-border flex flex-col items-center justify-center">
        <Building2 className="w-6 h-6 md:w-8 md:h-8 text-muted-foreground" />
        <span className="text-xs mt-1">School</span>
      </div>
      <p className="text-center mt-2 text-sm text-muted-foreground">ACH Transfer</p>
    </motion.div>

    {/* Step 3: Rewards destination (bottom) */}
    <motion.div style={{ y: rewardsY, opacity: rewardsOpacity }} className="absolute right-[10%] bottom-[20%]">
      <div className="w-20 h-20 md:w-24 md:h-24 rounded-xl bg-gradient-to-br from-amber-500/20 to-amber-600/20 border-2 border-amber-500/50 flex flex-col items-center justify-center">
        <Gift className="w-6 h-6 md:w-8 md:h-8 text-amber-500" />
        <span className="text-xs mt-1 text-amber-600">You</span>
      </div>
      <p className="text-center mt-2 text-sm font-medium text-amber-600">Earn Rewards</p>
    </motion.div>

    {/* Step 3 label */}
    <motion.p style={{ opacity: step3Opacity }} className="absolute bottom-16 text-center font-medium">
      Everyone wins
    </motion.p>
  </div>
</div>
```

IMPORTANT: All transforms must use GPU-accelerated properties only (transform, opacity). No animating width, height, colors, etc.
  </action>
  <verify>File exists, exports PaymentFlowAnimation, TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Multi-phase payment flow animation responds to scroll progress</done>
</task>

<task type="auto">
  <name>Task 2: Wire animation to section</name>
  <files>components/how-it-works/how-it-works-section.tsx</files>
  <action>
Update HowItWorksSection to render PaymentFlowAnimation with scroll progress.

Changes:
1. Add import: `import { PaymentFlowAnimation } from './payment-flow-animation'`
2. Replace placeholder content inside sticky viewport with:
   `<PaymentFlowAnimation progress={scrollYProgress} />`
3. Add subtle background treatment to sticky viewport:
   - bg-gradient-to-b from-background via-muted/30 to-background

Updated JSX for animated version:
```jsx
<section
  ref={containerRef}
  id="how-it-works"
  className="relative h-[175vh]"
>
  <div className="sticky top-0 h-screen overflow-hidden bg-gradient-to-b from-background via-muted/30 to-background">
    <PaymentFlowAnimation progress={scrollYProgress} />
  </div>
</section>
```
  </action>
  <verify>
`npm run build` succeeds.
Visual: Scroll through section, see card enter, path draw, destinations appear.
  </verify>
  <done>Payment flow animation integrated with scroll progress</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - TypeScript compiles
2. `npm run build` - Build succeeds
3. Animation phases:
   - Scroll 0-33%: Card slides in from left
   - Scroll 25-70%: Path draws, showing flow
   - Scroll 60-100%: ACH and Rewards destinations appear and separate
4. 60fps: No visible jank during scroll (test on real device if possible)
5. Phase transitions: Smooth blending between phases (no abrupt changes)
</verification>

<success_criteria>
- Card swipe animation visible during first third of scroll
- SVG path draws progressively during middle scroll
- ACH and Rewards destinations animate apart during final scroll
- Animation maintains 60fps
- Labels appear and fade at appropriate scroll positions
</success_criteria>

<output>
After completion, create `.planning/phases/07-how-it-works/07-02-SUMMARY.md`
</output>
