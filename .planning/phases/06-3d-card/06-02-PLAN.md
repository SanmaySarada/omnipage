---
phase: 06-3d-card
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/three/card/use-device-orientation.ts
  - components/three/card/card-interactive.tsx
autonomous: true

must_haves:
  truths:
    - "Card smoothly follows mouse cursor on desktop"
    - "Card rotation is frame-rate independent (60fps on 60Hz, same speed on 120Hz)"
    - "Gyroscope permission can be requested via user gesture on iOS"
  artifacts:
    - path: "components/three/card/use-device-orientation.ts"
      provides: "Device orientation hook with iOS permission handling"
      exports: ["useDeviceOrientation"]
    - path: "components/three/card/card-interactive.tsx"
      provides: "Interactive card wrapper with rotation logic"
      exports: ["CardInteractive"]
  key_links:
    - from: "components/three/card/card-interactive.tsx"
      to: "maath"
      via: "dampE easing import"
      pattern: "import.*easing.*maath"
    - from: "components/three/card/card-interactive.tsx"
      to: "@react-three/fiber"
      via: "useFrame hook"
      pattern: "useFrame"
---

<objective>
Create the useDeviceOrientation hook for mobile gyroscope input and the CardInteractive wrapper that handles cursor/gyroscope-reactive rotation.

Purpose: Enable user interaction with the card - mouse tracking on desktop, device tilt on mobile - with smooth, frame-rate-independent animation.

Output: useDeviceOrientation hook with iOS permission flow, CardInteractive component with dampE-based rotation following.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-3d-card/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useDeviceOrientation hook</name>
  <files>components/three/card/use-device-orientation.ts</files>
  <action>
Create the device orientation hook with iOS 13+ permission handling:

1. **'use client' directive**

2. **Interface DeviceOrientationData:**
   - alpha: number | null (compass, 0-360)
   - beta: number | null (front-back tilt, -180 to 180)
   - gamma: number | null (left-right tilt, -90 to 90)

3. **Type PermissionState:** 'granted' | 'denied' | 'prompt' | 'unsupported'

4. **Hook implementation:**
   - State for orientation data (all null initially)
   - State for permission status
   - State for isSupported (check typeof DeviceOrientationEvent)

5. **requestPermission callback:**
   - Check if DeviceOrientationEvent.requestPermission exists (iOS 13+)
   - If exists: call it, await result, set permission state
   - If not exists: auto-grant (Android/desktop don't need permission)
   - Return boolean for success
   - IMPORTANT: Must be called from user gesture (click/tap) on iOS

6. **Effect to listen for orientation events:**
   - Only attach listener when permission === 'granted'
   - Update orientation state on deviceorientation event
   - Clean up listener on unmount

7. **Return object:** { orientation, permission, isSupported, requestPermission }

Reference: 06-RESEARCH.md Pattern 4 and Common Pitfall 2 for iOS permission quirk.
  </action>
  <verify>
File exists at components/three/card/use-device-orientation.ts.
Contains 'use client' directive.
Exports useDeviceOrientation hook.
Has DeviceOrientationEvent.requestPermission check for iOS.
Returns { orientation, permission, isSupported, requestPermission }.
Run `npm run build` - should compile.
  </verify>
  <done>useDeviceOrientation hook exists with iOS permission handling and orientation state</done>
</task>

<task type="auto">
  <name>Task 2: Create CardInteractive wrapper component</name>
  <files>components/three/card/card-interactive.tsx</files>
  <action>
Create the interactive wrapper that handles rotation:

1. **'use client' directive**

2. **Imports:**
   - useRef from react
   - useFrame from @react-three/fiber
   - easing from maath
   - Group type from three
   - CardModel from ./card-model (will be created in 06-01)

3. **Props interface CardInteractiveProps:**
   - gyroscopeEnabled?: boolean (default false)
   - gyroscopeData?: { beta: number | null; gamma: number | null }

4. **Component implementation:**
   - Create ref for group: useRef<Group>(null!)
   - Define rotationFactor = 0.25 (about 14 degrees max tilt)

5. **useFrame logic (CRITICAL - no setState!):**
   - Calculate target rotation based on input source:
   - If gyroscopeEnabled AND gyroscopeData.gamma is not null:
     - targetRotationY = (gamma / 45) * rotationFactor
     - targetRotationX = ((beta - 45) / 45) * rotationFactor (offset for natural hold)
   - Else (desktop mouse):
     - targetRotationY = state.pointer.x * rotationFactor
     - targetRotationX = -state.pointer.y * rotationFactor (inverted)

6. **Apply dampE for smooth interpolation:**
   ```typescript
   easing.dampE(
     cardRef.current.rotation,
     [targetRotationX, targetRotationY, 0],
     0.2,  // smoothing time
     delta // frame delta for refresh-rate independence
   )
   ```

7. **Render:**
   - Wrap CardModel in a group with the ref
   - CardModel is a child (imported from ./card-model)

CRITICAL: Never call useState/setState in useFrame - causes 60 re-renders/second.
Use direct mutation via ref.current.rotation.

Note: CardModel import will error until plan 06-01 completes. This is expected since these plans run in parallel. TypeScript may show error but won't block build if file doesn't exist yet.
  </action>
  <verify>
File exists at components/three/card/card-interactive.tsx.
Contains 'use client' directive.
Imports useFrame from @react-three/fiber.
Imports easing from maath.
Uses dampE with delta parameter.
Does NOT contain useState calls inside useFrame.
Uses useRef<Group> for the card container.
Run `npm run build` - may show import error for CardModel if 06-01 not complete yet.
  </verify>
  <done>CardInteractive component uses dampE in useFrame for smooth cursor-following rotation without setState</done>
</task>

</tasks>

<verification>
1. Both files exist in components/three/card/
2. useDeviceOrientation handles iOS permission flow
3. CardInteractive uses maath dampE with delta
4. No useState calls inside useFrame in CardInteractive
5. TypeScript compiles (modulo cross-plan import that will resolve)
</verification>

<success_criteria>
- useDeviceOrientation exports hook with { orientation, permission, isSupported, requestPermission }
- CardInteractive applies rotation via dampE with delta for frame-rate independence
- Gyroscope path uses (beta - 45) offset for natural holding angle
- Mouse path uses state.pointer.x and -state.pointer.y (inverted)
- No React state updates inside useFrame
</success_criteria>

<output>
After completion, create `.planning/phases/06-3d-card/06-02-SUMMARY.md`
</output>
